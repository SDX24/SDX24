#!/bin/sh

# Run lint-staged first
bunx lint-staged

# Type check to ensure no errors
echo "Running type check..."
bun run type-check
if [ $? -ne 0 ]; then
  echo "❌ TypeScript errors detected. Commit blocked."
  echo "Fix type errors before committing."
  exit 1
fi

# Context update enforcement based on staged files
STAGED_STATUS=$(git diff --cached --name-status)
STAGED_FILES=$(echo "$STAGED_STATUS" | awk '{print $2}' | tr '\n' ' ')

needs_project_structure=false
needs_tech_stack=false
needs_devops=false
needs_components_context=false
needs_context_readme=false

# Project structure changes (add/rename/delete in key directories)
if echo "$STAGED_STATUS" | grep -E '^(A|D|R|C)' >/dev/null 2>&1; then
  if echo "$STAGED_STATUS" | grep -E '^(A|D|R|C).*\s(apps/web/src/(app|components|lib|utils|types)|apps/web/public|packages/)' >/dev/null 2>&1; then
    needs_project_structure=true
  fi
fi

# Component additions require components context update
if echo "$STAGED_STATUS" | grep -E '^(A|R|C).*\sapps/web/src/components/.*\.tsx$' >/dev/null 2>&1; then
  needs_components_context=true
fi

# Dependency changes (package.json or bun.lock)
if echo "$STAGED_FILES" | grep -E '(^|\s)(apps/web/)?package\.json(\s|$)|(^|\s)packages/.*/package\.json(\s|$)|(^|\s)package\.json(\s|$)|(^|\s)bun\.lock(\s|$)' >/dev/null 2>&1; then
  needs_tech_stack=true
fi

# DevOps/CI changes
if echo "$STAGED_FILES" | grep -E '(^|\s)(\.github/workflows/|\.husky/|scripts/|turbo\.json|eslint\.config\.cjs|lint-staged\.config\.js|commitlint\.config\.js|knip\.config\.ts|playwright\.config\.ts|apps/web/vercel\.json)(\s|$)' >/dev/null 2>&1; then
  needs_devops=true
fi

# New .context markdown files require README update
if echo "$STAGED_STATUS" | grep -E '^(A|R|C).*\s\.context/.*\.md$' | grep -v -E '\.context/README\.md$' >/dev/null 2>&1; then
  needs_context_readme=true
fi

context_staged=$(git diff --cached --name-only | grep '^\.context/' || true)

if [ "$needs_project_structure" = true ]; then
  if ! echo "$context_staged" | grep -q '^\.context/project-structure\.md$'; then
    echo "❌ Context update required: .context/project-structure.md"
    echo "Reason: project structure changed in staged files."
    exit 1
  fi
fi

if [ "$needs_tech_stack" = true ]; then
  if ! echo "$context_staged" | grep -q '^\.context/tech-stack\.md$'; then
    echo "❌ Context update required: .context/tech-stack.md"
    echo "Reason: dependency change detected in staged files."
    exit 1
  fi
fi

if [ "$needs_devops" = true ]; then
  if ! echo "$context_staged" | grep -q '^\.context/devops-rules\.md$'; then
    echo "❌ Context update required: .context/devops-rules.md"
    echo "Reason: DevOps/CI/config changes detected in staged files."
    exit 1
  fi
fi

if [ "$needs_components_context" = true ]; then
  if ! echo "$context_staged" | grep -q '^\.context/components\.md$'; then
    echo "❌ Context update required: .context/components.md"
    echo "Reason: new component added under apps/web/src/components/."
    exit 1
  fi
fi

if [ "$needs_context_readme" = true ]; then
  if ! echo "$context_staged" | grep -q '^\.context/README\.md$'; then
    echo "❌ Context update required: .context/README.md"
    echo "Reason: new .context markdown file added/renamed."
    exit 1
  fi
fi

# Non-blocking optimization advisory on staged files
bash scripts/optimization-advisory.sh || true

# Check for common issues
echo "Checking for common issues..."

# Get list of source files (exclude hooks, configs, build artifacts)
SOURCE_FILES=$(git diff --cached --name-only | grep -v -E '(\.husky|node_modules|\.next|dist|build)' | grep -E '\.(tsx?|jsx?)$' || true)

# Check for console.log in production code - WARNING ONLY
if [ -n "$SOURCE_FILES" ]; then
  CONSOLE_FILES=$(echo "$SOURCE_FILES" | grep -v -E '(test|spec|e2e|\.config\.)' | xargs grep -l 'console\.log' 2>/dev/null || true)
  if [ -n "$CONSOLE_FILES" ]; then
    echo "⚠️  Warning: console.log found in source files (removed in production build)"
  fi
fi

# Check for TODO/FIXME without context in source files
if [ -n "$SOURCE_FILES" ]; then
  TODO_MATCHES=$(echo "$SOURCE_FILES" | xargs grep -n -E '(TODO|FIXME):?\s*$' 2>/dev/null || true)
  if [ -n "$TODO_MATCHES" ]; then
    echo "$TODO_MATCHES"
    echo "❌ TODO/FIXME found without description. Add context after TODO/FIXME"
    exit 1
  fi
fi

# Check for debugger statements in source files
if [ -n "$SOURCE_FILES" ]; then
  DEBUGGER_MATCHES=$(echo "$SOURCE_FILES" | xargs grep -n '\bdebugger\b' 2>/dev/null || true)
  if [ -n "$DEBUGGER_MATCHES" ]; then
    echo "$DEBUGGER_MATCHES"
    echo "❌ debugger statement found. Remove before committing."
    exit 1
  fi
fi

# Check for hardcoded localhost URLs (except in config files)
CONFIG_EXCLUDED=$(git diff --cached --name-only | grep -v -E '(config|\.env|\.husky|playwright\.config)' || true)
if [ -n "$CONFIG_EXCLUDED" ]; then
  LOCALHOST_MATCHES=$(echo "$CONFIG_EXCLUDED" | xargs grep -n 'http://localhost' 2>/dev/null || true)
  if [ -n "$LOCALHOST_MATCHES" ]; then
    echo "$LOCALHOST_MATCHES"
    echo "❌ Hardcoded localhost URL found. Use environment variables."
    exit 1
  fi
fi

# Check for large files (>500KB)
for file in $(git diff --cached --name-only); do
  if [ -f "$file" ]; then
    size=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 512000 ]; then
      echo "❌ Large file detected: $file ($(($size / 1024))KB)"
      echo "Files over 500KB should not be committed to git"
      exit 1
    fi
  fi
done

echo "✅ Pre-commit checks passed!"

# E2E Test Reminder System
E2E_TRACKER=".e2e-tracker"

# Initialize tracker if it doesn't exist
if [ ! -f "$E2E_TRACKER" ]; then
  echo '{"commitsSinceLastE2e":0,"lastE2eRun":"never","runE2eEvery":5}' > "$E2E_TRACKER"
fi

# Check if commit message contains E2E flags
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ -f "$COMMIT_MSG_FILE" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE" 2>/dev/null || echo "")
else
  COMMIT_MSG=""
fi

# Read current counter
CURRENT_COUNT=$(grep -o '"commitsSinceLastE2e":[0-9]*' "$E2E_TRACKER" | cut -d':' -f2)

# Check for E2E flags in commit message
if echo "$COMMIT_MSG" | grep -qE '\[e2e:.*✅.*\]'; then
  # E2E test was run - reset counter
  sed -i.bak 's/"commitsSinceLastE2e":[0-9]*/"commitsSinceLastE2e":0/' "$E2E_TRACKER"
  sed -i.bak "s/\"lastE2eRun\":\"[^\"]*\"/\"lastE2eRun\":\"$(date +%Y-%m-%d)\"/" "$E2E_TRACKER"
  rm -f "${E2E_TRACKER}.bak"
  echo "✅ E2E counter reset (test confirmed)"
elif echo "$COMMIT_MSG" | grep -qE '\[skip-e2e\]'; then
  # Skip incrementing counter
  echo "⏭️  E2E counter not incremented (skip flag used)"
else
  # Increment counter
  NEW_COUNT=$((CURRENT_COUNT + 1))
  sed -i.bak "s/\"commitsSinceLastE2e\":[0-9]*/\"commitsSinceLastE2e\":$NEW_COUNT/" "$E2E_TRACKER"
  rm -f "${E2E_TRACKER}.bak"
  
  # Show reminder if counter reaches threshold
  if [ "$NEW_COUNT" -ge 5 ]; then
    echo ""
    echo "⚠️  E2E TEST REMINDER: $NEW_COUNT commits since last E2E test"
    echo "   Run: bun run test:e2e"
    echo "   Then add [e2e: ✅] to next commit message to reset counter"
    echo "   Or add [skip-e2e] to this commit to skip increment"
    echo ""
  fi
fi
